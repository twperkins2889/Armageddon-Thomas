STEP 1 — CREATE THE VPC 

Create VPC:
VPC & more
Name = Lab-Vpc
IPv4 CIDR block = 10.161.0.0/16
# of AZs = 2
You will need 2 public & 2 private subnets
Customize subnets CIDR blocks = Public subnet CIDR block in us-east-1a                                                                   			           10.161.1.0/24	                                           	                           Public subnet CIDR block in us-east-1b  
                                   10.161.2.0/24    
                                   Private subnet CIDR block in us-east-1a 
                                   10.161.11.0/24    
                                   Private subnet CIDR block in us-east-1b
                                   10.161.12.0/24
Make sure DNS hostname/resolution is checked
Create VPC          

STEP 2 — CREATE (2) SECURITY GROUPS   

Create security group      
SG name = Ec2-sg-app  (sg for instance)  (sg-07e4211f04f9e790e | Ec2-sg-app) 
Attach to Lab-Vpc
Inbound rules =  SSH/22/0.0.0.0/0 & HTTP/80/0.0.0.0/0   
Outbound rules = DO NOT TOUCH!!!
Create security group

Create security group
SG name = rds-sg  (sg for rds database) (sg-023a3317c03efe4d5 | rds-sg)
Attach to Lab-Vpc
Inbound rules =  MySQL/Aurora - 3306 - ec2-sg-app
Outbound rules = DO NOT TOUCH!!!
Create security group

STEP 3 — CREATE RDS MYSQL

Database creation method = Full Configuration
Engine = MYSQL
Version = Whatever the default is
Templates = Free tier
Availability and durability = Single-AZ DB instance deployment (1 instance)
DB instance identifier = lab-MySQL
Master Username = admin & Master password = Builttolast!!
Virtual private cloud (VPC) = Lab-vpc
Public access = No
VPC security group:
Remove default & add rds-sg (sg-023a3317c03efe4d5)
Make sure to check all log export boxes
Create datbase

STEP 4 — SECRETS MANAGER

Secret type: RDS credentials

Database:

Select lab-mysql

Username = admin

Password = Builttolast!!

Secret name:lab/rds/MySQL

Disable rotation

Create secret

STEP 5 — IAM POLICY

IAM → Policies → Create policy → JSON

{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "ReadOnlyListActions",
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeInstances",
                "ec2:DescribeSecurityGroups",
                "rds:DescribeDBInstances"
            ],
            "Resource": "*"
        },
        {
            "Sid": "ReadSpecificSecret",
            "Effect": "Allow",
            "Action": [
                "secretsmanager:GetSecretValue"
            ],
            "Resource": "arn:aws:secretsmanager:us-east-1:958699786524:secret:lab/rds/mysql*"
        }
    ]
}

Policy name = EC2ReadLabRdsSecret
Create policy

STEP 6 — IAM ROLE FOR EC2

IAM → Roles → Create role

Trusted entity = AWS service
Service = EC2
Attach policy = EC2ReadLabRdsSecret
Role name = ec2-lab-read-secret-role


STEP 7 — LAUNCH EC2

Name = lab-ec2-app (i-09f9a4730c27ffaa4)
AMI = Amazon Linux 2023
Create new key pair = lab-ec2-app
Attach to Lab-vpc
Subnet = Public1-us-east-1a
Auto-assign public IP = Enable
Attach existing security group = Ec2-sg-app (sg-07e4211f04f9e790e)
Attach to IAM role = ec2-lab-read-secret-role
User data =

#!/bin/bash
dnf update -y
dnf install -y python3-pip
pip3 install flask pymysql boto3
sudo dnf install mariadb105 -y

mkdir -p /opt/rdsapp
cat >/opt/rdsapp/app.py <<'PY'
import json
import os
import boto3
import pymysql
from flask import Flask, request

REGION = os.environ.get("AWS_REGION", "us-east-1")
SECRET_ID = os.environ.get("SECRET_ID", "lab/rds/mysql")

secrets = boto3.client("secretsmanager", region_name=REGION)

def get_db_creds():
    resp = secrets.get_secret_value(SecretId=SECRET_ID)
    s = json.loads(resp["SecretString"])
    # When you use "Credentials for RDS database", AWS usually stores:
    # username, password, host, port, dbname (sometimes)
    return s

def get_conn():
    c = get_db_creds()
    host = c["host"]
    user = c["username"]
    password = c["password"]
    port = int(c.get("port", 3306))
    db = c.get("dbname", "labdb")  # we'll create this if it doesn't exist
    return pymysql.connect(host=host, user=user, password=password, port=port, database=db, autocommit=True)

app = Flask(__name__)

@app.route("/")
def home():
    return """
    <h2>EC2 → RDS Notes App</h2>
    <p>POST /add?note=hello</p>
    <p>GET /list</p>
    """

@app.route("/init")
def init_db():
    c = get_db_creds()
    host = c["host"]
    user = c["username"]
    password = c["password"]
    port = int(c.get("port", 3306))

    # connect without specifying a DB first
    conn = pymysql.connect(host=host, user=user, password=password, port=port, autocommit=True)
    cur = conn.cursor()
    cur.execute("CREATE DATABASE IF NOT EXISTS labdb;")
    cur.execute("USE labdb;")
    cur.execute("""
        CREATE TABLE IF NOT EXISTS notes (
            id INT AUTO_INCREMENT PRIMARY KEY,
            note VARCHAR(255) NOT NULL
        );
    """)
    cur.close()
    conn.close()
    return "Initialized labdb + notes table."

@app.route("/add", methods=["POST", "GET"])
def add_note():
    note = request.args.get("note", "").strip()
    if not note:
        return "Missing note param. Try: /add?note=hello", 400
    conn = get_conn()
    cur = conn.cursor()
    cur.execute("INSERT INTO notes(note) VALUES(%s);", (note,))
    cur.close()
    conn.close()
    return f"Inserted note: {note}"

@app.route("/list")
def list_notes():
    conn = get_conn()
    cur = conn.cursor()
    cur.execute("SELECT id, note FROM notes ORDER BY id DESC;")
    rows = cur.fetchall()
    cur.close()
    conn.close()
    out = "<h3>Notes</h3><ul>"
    for r in rows:
        out += f"<li>{r[0]}: {r[1]}</li>"
    out += "</ul>"
    return out

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=80)
PY

cat >/etc/systemd/system/rdsapp.service <<'SERVICE'
[Unit]
Description=EC2 to RDS Notes App
After=network.target

[Service]
WorkingDirectory=/opt/rdsapp
Environment=SECRET_ID=lab/rds/mysql
ExecStart=/usr/bin/python3 /opt/rdsapp/app.py
Restart=always

[Install]
WantedBy=multi-user.target
SERVICE

systemctl daemon-reload
systemctl enable rdsapp
systemctl start rdsapp


 arn:aws:iam::958699786524:policy/EC2ReadLabRdsSecret



                                                                                                                                                